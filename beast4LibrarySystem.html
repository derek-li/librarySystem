<script src="../simpletest.js"></script>
<script>

//It should create a library object with dependent library names, callback function, and call counter.
//It should call the callback 
//It should apply the required libraries only when the library is called
//It should check if the library has already been called

(function() {
	
	var libraryStorage = {};

	function librarySystem(libraryName, array, callback) {
		//For clarity. If using library(case 2), call from storage and set to this variable
		var library = libraryStorage[libraryName];
		//Creates a new library if there's more than one argument
		if (arguments.length > 1) {
			//New libraries are stored as objects
			var newLibrary = {
				dependentFunctions: array,
				callback: callback,
				calledBefore: false
			};
			//Store newLibrary object as the passed in name
			libraryStorage[libraryName] = newLibrary;
		//Use library from storage
		} else {
			//Checks if library has already been called. Returns nothing if true
			if (library.calledBefore === true) {
				return;
			}
			//Permanently sets calledBefore property to true
			library.calledBefore = true;
			//Check for dependencies
			if (library.dependentFunctions.length > 0) {
				//Set dependentFunctions property to mapped array of required libraries
				library.dependentFunctions = library.dependentFunctions.map(function(requiredLibrary) {
					return librarySystem(requiredLibrary);
				});
				//Returns callback with applied dependent functions
				return library.callback.apply(null, library.dependentFunctions);
			} else {
				//Returns callback
				return library.callback();
			}
		}
	}

	window.librarySystem = librarySystem;

})();

tests({

	'it should store and retrieve libraries': function() {
		librarySystem('sampleLibrary', [], function() {
			return 'hello';
		});
		eq(librarySystem('sampleLibrary'), 'hello');
	},

	'it should be able to run dependent libraries before running the callback': function() {
		librarySystem('moniker', [], function() {
			return 'derek'
		});
		librarySystem('salutations', ['moniker'], function(moniker) {
			return 'hi ' + moniker;
		});
		eq(librarySystem('salutations'), 'hi derek');
	},

	'it should be able to store libraries with dependencies before storing the dependent functions': function() {
		librarySystem('greeting', ['name'], function(name) {
			return 'hi ' + name;
		});
		librarySystem('name', [], function() {
			return 'derek'
		});
		eq(librarySystem('greeting'), 'hi derek');
	},

	'it should allow each library to be called only once': function() {
		librarySystem('runOnlyOnce', [], function() {
			return 'This is the first call';
		});
		librarySystem('runOnlyOnce');
		eq(librarySystem('runOnlyOnce'), undefined);
	},

	'it should allow each library to be called only once INCLUDING dependencies': function() {
		librarySystem('animal', [], function() {
			return 'cat';
		});
		librarySystem('action', ['animal'], function(animal) {
			return 'pet ';
		});
		librarySystem('action');
		eq(librarySystem('animal'), undefined);
	}

});
</script>
